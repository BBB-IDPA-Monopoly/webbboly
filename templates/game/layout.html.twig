{% extends 'base.html.twig' %}

{% block title %}
    Game #{{ game.code }}
{% endblock %}

{% block body %}
    <div {{ turbo_stream_listen('https://webbboly/game/' ~ game.code) }}></div>
    <div {{ turbo_stream_listen('https://webbboly/game/' ~ game.code ~ '/player/' ~ currentPlayer.number) }}></div>

    <div id="game">
        <div id="boardContainer">
            {% block playing_field %}
                {% include 'game/partials/_board.html.twig' %}
            {% endblock %}
        </div>
        <div id="actions" {{ stimulus_controller('turn', {
            enabled: currentPlayer is same as(game.currentTurnPlayer ),
            gameCode: game.code,
            playerId: currentPlayer.id,
            position: currentPlayer.position
        }) }}>
            {% block actions %}
                {% include 'game/partials/_actions.html.twig' %}
            {% endblock %}
        </div>
        <div id="players">
            {% block players %}
                {% include 'game/partials/_players.html.twig' %}
            {% endblock %}
        </div>
    </div>

    <script>
        const eventSource = new EventSource(
            '{{ mercure('https://webbboly/game/' ~ game.code ~ '/player/' ~ currentPlayer.number ~ '/turn') }}'
        );

        eventSource.onmessage = message => {
            const data = JSON.parse(message.data);
            const event = new CustomEvent(data.event, {
                detail: data
            });

            document.getElementById('actions').dispatchEvent(event);
        };
    </script>

    <div id="modal"></div>
{% endblock %}
